<div class="page-container">
    <header class="page-header">
        <div class="breadcrumb">
            <span>MedNex</span> / <span class="active">Financial Management</span>
        </div>
        <div class="header-main">
            <h1>Invoicing & Billing</h1>
            <p>Manage patient invoices, insurance claims, and financial summaries.</p>
        </div>
    </header>

    <div class="billing-summary">
        <div class="summary-item">
            <span class="label">TOTAL COLLECTED (MTD)</span>
            <h2 class="value text-green">{{ stats().totalCollected | currency }}</h2>
        </div>
        <div class="summary-item">
            <span class="label">OUTSTANDING BALANCE</span>
            <h2 class="value text-red">{{ stats().outstanding | currency }}</h2>
        </div>
        <div class="summary-item">
            <span class="label">PENDING CLAIMS</span>
            <h2 class="value text-blue">{{ stats().pending | currency }}</h2>
        </div>
    </div>

    <div class="action-bar">
        <div class="search-box">
            <span class="material-icons-round search-icon">search</span>
            <input type="text" placeholder="Search Invoices, patients..." [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event)">
        </div>

        <div class="actions">
            <button class="btn-secondary">
                <span class="material-icons-round">file_download</span>
                Revenue Report
            </button>
            <button class="btn-primary" routerLink="/billing/new">
                Create Invoice
            </button>
        </div>
    </div>

    <div class="table-container card">
        <table>
            <thead>
                <tr>
                    <th>INVOICE ID</th>
                    <th>PATIENT</th>
                    <th>DATE</th>
                    <th>METHOD</th>
                    <th>AMOUNT</th>
                    <th>STATUS</th>
                    <th class="text-center">ACTIONS</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let inv of filteredInvoices()">
                    <td><span class="id-badge">{{ inv.invoiceNumber }}</span></td>
                    <td><strong>{{ inv.patientName }}</strong></td>
                    <td>{{ inv.date }}</td>
                    <td>{{ inv.method | titlecase }}</td>
                    <td class="amount-cell">{{ inv.amount | currency }}</td>
                    <td>
                        <span class="status-badge" [ngClass]="getStatusClass(inv.status)">
                            {{ inv.status | titlecase }}
                        </span>
                    </td>
                    <td class="table-actions">
                        <button class="action-btn" (click)="showQr(inv.id)" title="QR Payment">
                            <span class="material-icons-round">qr_code</span>
                        </button>
                        <button class="action-btn" (click)="download(inv.id)" title="Download PDF">
                            <span class="material-icons-round">file_download</span>
                        </button>
                        <button class="action-btn" (click)="deleteInvoice(inv.id)" title="Delete Invoice">
                            <span class="material-icons-round text-red">delete</span>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card qr-container" *ngIf="qrUrl()">
        <button class="close-btn" (click)="closeQr()">
            <span class="material-icons-round">close</span>
        </button>
        <h3>QR Payment Code</h3>
        <img [src]="qrUrl()" width="200" alt="QR Code for Payment">
        <p class="hint">Scanning for payment... (Auto-refresh active)</p>
    </div>
</div>